{"version":3,"sources":["slab/tokens.cljs"],"mappings":";AAIA,AAAKA,mCAEH,KAAAC,OAAA,iCAAA;AAEF,gCAAA,hCAAOC;AAAP,AACE,IAAMC,IAAE,iBAAAC,mBAAI,AAAYC;AAAhB,AAAA,oBAAAD;AAAAA;;AAAA;;;IACFE,mGAASH,vBACA,yBAAA,OAAA,hCAACI,vBACD,2DAAA,QAAA,nEAACA,vBACD,8FAAA,OAAA,rGAACA,vBACD,gIAAA,WAAA,3IAACA;AALhB,AAME,GAAI,AAACC,cAAIF;AAAMA;;AAAf;;;AAEJ;;;;8BAAA,9BAAOG,oEAGAC;AAHP,AAIE,IAAOC,MAAID;;AAAX,AACE,GACE,QAAA,PAAMC;AADR;;AAAA,GAEE,iBAAMC,KAAG,AAAMD;AAAf,AACE,SAAK,OAASC,qBAAI,qCAAA,rCAACC,kCAAiBD;;AAA2BE;;AAHnE,AAIQ,cAAO,AAAiBH;;;;;;;;;AAEpC;;;yBAAA,zBAAMI,0DAECL;AAFP,AAAA,kDAAA,0FAAA,iGAAA,nIAGa,qBAAA,rBAACM,kBAAUN,6EACX,qBAAA,rBAACM,kBAAUN,6EACX,iBAAAN,mBAAI,qBAAA,rBAACY,kBAAUN;AAAf,AAAA,oBAAAN;AAAAA;;AAAA,IAAAA,uBACI,AAACK,4BAAgBC;AADrB,AAAA,oBAAAN;AAAAA;;AAEI,OAACF;;;KAPlB,wDAAA;;AAUA,0BAAA,1BAAOe,4DAAaC,MAAMC,SAASC;AAAnC,AACE,IAAMV,KAAG,uBAAA,vBAAgBW;AAAzB,AACE,gBAAA,fAAM,AAAaX;;AACnB,gBAAA,mBAAA,nCAAeA;;AACf,gBAAA,hBAAeA,kCAAqBQ;;AACpC,gBAAA,hBAAeR,qCAAwBS;;AACvC,oBAAMC;AAAN,AACE,gBAAA,hBAAeV,oCAAuBU;;AADxC;;AAEA,CAAM,AAAeV,iBAAI,CAAA,uDAAA,PAASQ;;AAClCR;;AAEJ,yBAAA,zBAAOY,0DAAYH;AAAnB,AACE,IAAMI,OAAK,uBAAA,vBAAgBF;AAA3B,AACE,kBAAA,jBAAM,AAAaE;;AACnB,kBAAA,lBAAeA,mCAAsBJ;;AACrCI;;AAEJ;;;sCAAA,tCAAOC,oFAEAC,UAAUC;AAFjB,AAGE,IAAAC,qBAAa,AAAcF;AAA3B,AAAA,oBAAAE;AAAA,AAAA,QAAAA,JAAWxB;AAAX,AACE,IAAAyB,iBAAA,AAAApB,cAAUkB;IAAVG,mBAAA;IAAAC,mBAAA;IAAAC,eAAA;;AAAA,AAAA,GAAA,AAAA,CAAAA,eAAAD;AAAA,aAAA,AAAAD,sDAAAE,/DAAQQ;AAAR,AAAA,AACE,AAAepC,eAAEoC,OAAEd;;AADrB;AAAA,cAAAG;cAAAC;cAAAC;cAAA,CAAAC,eAAA;;;;;;;AAAA,IAAAJ,8BAAA,AAAAnB,cAAAoB;AAAA,AAAA,GAAAD;AAAA,AAAA,IAAAC,qBAAAD;AAAA,AAAA,GAAA,AAAAK,6BAAAJ;AAAA,IAAAK,uBAAA,AAAAC,sBAAAN;AAAA,AAAA,cAAA,AAAAO,qBAAAP;cAAAK;cAAA,AAAAG,gBAAAH;cAAA;;;;;;;AAAA,aAAA,AAAAI,gBAAAT,zBAAQW;AAAR,AAAA,AACE,AAAepC,eAAEoC,OAAEd;;AADrB;AAAA,cAAA,AAAAa,eAAAV;cAAA;cAAA;cAAA;;;;;;;;AAAA;;;;;AAEA,OAAczB,cAAEsB;;AAHlB;;;AAKF,gCAAA,hCAAOe,wEAAkBC;AAAzB,AACE,gBAAA,fAAM,AAAaA;;AACnBA;;AAEF;;;;sCAAA,kDAAAC,xFAAOI,oFAGJC;AAHH,AAAA,IAAAJ,YAAAD;IAAAC,gBAAA,AAAAC,4BAAAD;WAAA,AAAAE,4CAAAF,cAAA,jEAGeK;cAHf,AAAAH,4CAAAF,cAAA,pEAGoBvB;cAHpB,AAAAyB,4CAAAF,cAAA,pEAG4BM;AAH5B,AAIE,AAACT,8BAAaxC;;AACd,eAAA,XAAOkD;IACAC,IAAE,AAAOnD,sCAAqB+C;UADrC,NAEOK;;AAFP,AAGE,GAAI,MAAA,LAAMD;AACR,IAAME,OAAK,AAAYN,cAAIG;AAA3B,AACE,GAAM,AAAC1C,cAAI4C;AAAX,AACE,IAAAE,UAAQF;AAAR,AAAA,GACE,AAAC5C,cAAI6C;AAAM,oDAAAC,7CAACC,qDAAK,AAAiBlC,wBAAYgC;;AADhDC;;;AADF;;;AAGF,IAAME,YAAU,AAASL;IACnBjC,QAAU,GAAA,FAAMiC;IAChBM,YAAU,GAAA,FAAMN;IAChBO,SAAU,AAAYX,cAAIG,SAASM;IACnCG,IAAU,AAACC,mDAAMX,QAAQY;IACzB1C,WAAU,mDAAA,wDAAA,9DAAK6B,uDAAU9B,wDAAW,KAAA,JAAKyC;IACzCG,WAAU,AAAC7C,wBAAYC,MAAMC,SAASC;IACtC2C,UAAU,AAACzC,uBAAWH;AAP5B,AAQE,cAAO,CAAGqC,YAAU,AAAUC;cACvB,AAAOzD,sCAAqB+C;cAC5B,iBAAAiB,UAAQZ;IAARY,cAAA,+GAAAA,7GACE,AAACxD,cAAIkD,SAAQ,6CAAAM,7CAACT,qDAAK,AAAiBlC,wBAAYqC;IADlDM,cAAA,AAEe,6CAAAA,7CAACT,yDAAKO;;AAFrB,AAAA,AAGe,oDAAAE,7CAACT,yDAAKQ;;;;;;;;;;;AAEpC;;;8BAAA,9BAAOE,oEAEAC,KAAKC;AAFZ,AAGE,IAAMC,SAAO,oDAAA,KAAA,zDAAmB/C,0BAAY6C,KAAKG;AAAjD,AACE,IAAWC,OAAK,AAAWF;;AAA3B,AACE,oBAAME;AAAN,AACE,CAACH,kCAAAA,wCAAAA,RAAEG,oBAAAA;;AACH,cAAO,AAAWF;;;;AAFpB;;;;;AAIN;;;+CAAA,/CAAMG;AAAN,AAGE,IAAML,OAAK,iBAAA9D,mBAAI,wBAAA,xBAAiBiB;AAArB,AAAA,oBAAAjB;AAAAA;;AACI,OAAQiB;;;AADvB,AAEE,oBAAM6C;AAAN,AACE,IAAMlB,OAAQ,AAAC9C;IACT+C,UAAQ,6CAAA,7CAACuB;AADf,AAEE,OAACP,4BACAC,KACA,WAASI;AAAT,AACE,IAAMvB,MAAI,AAAauB;AAAvB,AACE,oBAAM,iBAAAG,oBAAK,OAAS1B;AAAd,AAAA,GAAA0B;AAAA,IAAAA,wBACK,kBAAA,lBAACC,yBAAgB3B;AADtB,AAAA,oBAAA0B;AAEK,OAACC,kBAAQ1E,iCAAqB+C;;AAFnC0B;;;AAAAA;;;AAAN,AAGE,IAAMrD,UAAQ,AAACX,4BAAgB,AAAiB6D;IAC1C5C,QAAQ,wCAAA,2CAAA,yDAAA,mEAAA,/MAACoB,oCAAwBC,mGAAWC,gEACG5B,kEACA6B;AAHrD,AAIE,GAAM,AAACzC,cAAIkB;AAAX,AACE,OAACF,oCAAmB8C,KAAK5C;;AAD3B;;;AAPJ;;;;AAPT","names":["slab.tokens/token-interactive-re","js/RegExp","slab.tokens/current-page-stem","p","or__5002__auto__","js/location","base","clojure.string/replace","cljs.core/seq","slab.tokens/find-section-id","el","cur","id","clojure.string/starts-with?","slab.tokens/id","slab.tokens/token-info","slab.util/dataset","slab.tokens/mk-token-el","token","token-id","section","js/document","slab.tokens/mk-slot-el","slot","slab.tokens/replace-text-node!","text-node","nodes","temp__5804__auto__","seq__6046","chunk__6047","count__6048","i__6049","cljs.core/chunked-seq?","c__5525__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/count","cljs.core/first","cljs.core/next","n","slab.tokens/reset-regex!","re","p__6050","map__6051","cljs.core/--destructure-map","cljs.core.get","slab.tokens/build-replacement-nodes","txt","page","counter","last-idx","m","out","tail","G__6069","cljs.core.conj","match-idx","match-str","before","i","cljs.core.swap_BANG_","cljs.core/inc","token-el","slot-el","G__6070","slab.tokens/walk-text-nodes","root","f","walker","js/NodeFilter.SHOW_TEXT","node","slab.tokens/hydrate-interactive-tokens!","cljs.core.atom","and__5000__auto__","cljs.core/re-find"],"sourcesContent":["(ns slab.tokens\n  (:require [clojure.string :as str]\n            [slab.util :as u]))\n\n(def token-interactive-re\n  ;; {{status*}} where status is [A-Za-z0-9_]+\n  (js/RegExp. \"\\\\{\\\\{([A-Za-z0-9_]+)\\\\*\\\\}\\\\}\" \"g\"))\n\n(defn- current-page-stem []\n  (let [p (or (.-pathname js/location) \"index.html\")\n        base (-> p\n                 (str/replace #\".*/\" \"\")\n                 (str/replace #\"\\?.*$\" \"\")\n                 (str/replace #\"#.*$\" \"\")\n                 (str/replace #\"\\.html?$\" \"\"))]\n    (if (seq base) base \"index\")))\n\n(defn- find-section-id\n  \"Nearest Org export outline container id.\n  Org HTML usually emits: <div id=\\\"outline-container-...\\\">\"\n  [^js el]\n  (loop [cur el]\n    (cond\n      (nil? cur) nil\n      (let [id (.-id cur)]\n        (and (string? id) (str/starts-with? id \"outline-container-\"))) id\n      :else (recur (.-parentElement cur)))))\n\n(defn token-info\n  \"Extract token metadata from an interactive token element.\"\n  [^js el]\n  {:token    (u/dataset el \"slabToken\")\n   :token-id (u/dataset el \"slabTokenId\")\n   :section  (or (u/dataset el \"slabSection\")\n                 (find-section-id el)\n                 (current-page-stem))\n   :params   {}})\n\n(defn- mk-token-el [token token-id section]\n  (let [el (.createElement js/document \"span\")]\n    (set! (.-className el) \"slab-token slab-token--interactive\")\n    (.setAttribute el \"data-slab-action\" \"run-token\")\n    (.setAttribute el \"data-slab-token\" token)\n    (.setAttribute el \"data-slab-token-id\" token-id)\n    (when section\n      (.setAttribute el \"data-slab-section\" section))\n    (set! (.-textContent el) (str \"[\" token \"*]\"))\n    el))\n\n(defn- mk-slot-el [token-id]\n  (let [slot (.createElement js/document \"div\")]\n    (set! (.-className slot) \"slab-output-slot\")\n    (.setAttribute slot \"data-slab-slot\" token-id)\n    slot))\n\n(defn- replace-text-node!\n  \"Replace a text node with nodes.\"\n  [^js text-node nodes]\n  (when-let [p (.-parentNode text-node)]\n    (doseq [n nodes]\n      (.insertBefore p n text-node))\n    (.removeChild p text-node)))\n\n(defn- reset-regex! [^js re]\n  (set! (.-lastIndex re) 0)\n  re)\n\n(defn- build-replacement-nodes\n  \"Turn a text string containing {{name*}} into a vector of DOM nodes.\n  Returns nil if no matches.\"\n  [txt {:keys [page section counter]}]\n  (reset-regex! token-interactive-re)\n  (loop [last-idx 0\n         m (.exec token-interactive-re txt)\n         out []]\n    (if (nil? m)\n      (let [tail (.substring txt last-idx)]\n        (when (seq out) ;; only return if we actually matched something\n          (cond-> out\n            (seq tail) (conj (.createTextNode js/document tail)))))\n      (let [match-idx (.-index m)\n            token     (aget m 1)\n            match-str (aget m 0)\n            before    (.substring txt last-idx match-idx)\n            i         (swap! counter inc)\n            token-id  (str page \"::\" token \"::\" (dec i))\n            token-el  (mk-token-el token token-id section)\n            slot-el   (mk-slot-el token-id)]\n        (recur (+ match-idx (.-length match-str))\n               (.exec token-interactive-re txt)\n               (cond-> out\n                 (seq before) (conj (.createTextNode js/document before))\n                 true         (conj token-el)\n                 true         (conj slot-el)))))))\n\n(defn- walk-text-nodes\n  \"Call f on each text node under root.\"\n  [^js root f]\n  (let [walker (.createTreeWalker js/document root js/NodeFilter.SHOW_TEXT nil false)]\n    (loop [^js node (.nextNode walker)]\n      (when node\n        (f node)\n        (recur (.nextNode walker))))))\n\n(defn hydrate-interactive-tokens!\n  \"Find {{name*}} occurrences in text nodes and replace with clickable tokens + slots.\"\n  []\n  (let [root (or (.getElementById js/document \"content\")\n                 (.-body js/document))]\n    (when root\n      (let [page    (current-page-stem)\n            counter (atom 0)]\n        (walk-text-nodes\n         root\n         (fn [^js node]\n           (let [txt (.-nodeValue node)]\n             (when (and (string? txt)\n                        (re-find #\"\\{\\{\" txt)\n                        (re-find token-interactive-re txt))\n               (let [section (find-section-id (.-parentElement node))\n                     nodes   (build-replacement-nodes txt {:page page\n                                                           :section section\n                                                           :counter counter})]\n                 (when (seq nodes)\n                   (replace-text-node! node nodes)))))))))))\n"]}